<%page args="type,path,field"/>

<div class="row">
<div class="span10 offset2">
<form class="form-inline">
<div class="input-append">
<input id="${type}name" class="input-small" placeholder="New ${type}" type="text">
  <div class="btn-group">
    <button class="btn dropdown-toggle" data-toggle="dropdown" required=" ">
          Create<span class="caret"></span></button>
    <ul id="${type}-create-dropdown" class="dropdown-menu">
      <li><a id="${type}create" typehref="#">Unconfigured ${type}</a></li>
    </ul>
  </div>
</div>
</form>
</div>
</div>

<div id="${type}-prompt-modal" class="modal hide fade" role="dialog"
     aria-labelledby="prompt-modal-label" aria-hidden="true">
  <div class="modal-header">
    <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Invalid Input</h3>
  </div>
  <div class="modal-body">
    The new ${type} name is invalid. It cannot be empty and
    may only contain the following characters: alphanumeric, '-', and
    '_'.
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>

<script type="text/javascript">
    $("#${type}create").click(function (e) {
        e.preventDefault();
        var name = $("#${type}name").val();
        if (name.match(/^[\w-]+$/g) === null) {
            $("#${type}-prompt-modal").modal("show");
        } else {
            $.ajax({
                url: "/v1.1/${type}s/" + name,
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify({}),
                processData: false,
                contentType: 'application/json',
                complete: function() {
                    window.location = "/admin/${type}s/" + name;
                },
            });
        }
    });

    function ${type}_process(result) {
        var keys = [];
        $.each(result['${field}'], function(index, value) {
            keys.push(value);
        });
        keys.sort();
        $.each(keys, function(index, endpoint) {
            $("#${type}-create-dropdown").append(
                '<li><a id="${type}-copy-' + endpoint +
                '" typehref="#">Clone of ${type} ' + endpoint + '</a></li>');
            $("#${type}-copy-" + endpoint).click(function (e) {
                e.preventDefault();
                var name = $("#${type}name").val();
                if (name.match(/^[\w-]+$/g) === null) {
                    $("#${type}-prompt-modal").modal("show");
                } else {
                    // Get config to copy
                    $.ajax({
                        url: '${path}/' + endpoint,
                        type: 'GET',
                        dataType: 'text', // Don't deserialize
                        success: function(result) {
                            // Just ping-pong it back to the server
                            $.ajax({
                                url: "${path}/" + name,
                                type: 'POST',
                                dataType: 'json',
                                data: result,
                                processData: false,
                                contentType: 'application/json',
                                complete: function() {
                                    window.location = "/admin/${type}s/" + name;
                                },
                            });
                        },
                    });
                }
            });
        });
    }

    // Populate "Copy from X" list
    $.ajax({
        url: '${path}',
        type: 'GET',
        dataType: 'json',
        success: ${type}_process, });
</script>
